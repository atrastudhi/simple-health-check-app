name: Deploy to Production
on:
  push:
    branches: [master]

concurrency:
  group: deploy
  cancel-in-progress: false

permissions:
  contents: read
  packages: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: "startsWith(github.event.head_commit.message, 'chore: release v')"
    steps:
      - uses: actions/checkout@v4
      
      - name: Extract version from package.json
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: v$VERSION"
      
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Deploy version with -released tag
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
        run: |
          echo "Deploying version: v$VERSION"
          echo "Repository owner: $REPO_OWNER"
          
          # Determine if owner is user or org
          echo "Detecting repository owner type..."
          OWNER_TYPE=$(gh api /users/$REPO_OWNER --jq '.type' 2>&1) || {
            echo "Failed to detect owner type, defaulting to user"
            OWNER_TYPE="User"
          }
          echo "Owner type: $OWNER_TYPE"
          
          if [ "$OWNER_TYPE" = "Organization" ]; then
            API_PATH="/orgs/$REPO_OWNER"
          else
            API_PATH="/users/$REPO_OWNER"
          fi
          echo "Using API path: $API_PATH"
          
          # Get package versions and find all -released tags
          echo "Finding existing -released tags..."
          RELEASED_VERSIONS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$API_PATH/packages/container/simple-health-check-app/versions" \
            --jq '.[] | select(.metadata.container.tags[] | endswith("-released")) | .metadata.container.tags[] | select(endswith("-released"))' 2>/dev/null || echo "")
          
          # Delete all -released tags
          if [ -n "$RELEASED_VERSIONS" ]; then
            echo "Found -released tags to remove:"
            echo "$RELEASED_VERSIONS"
            
            for TAG in $RELEASED_VERSIONS; do
              echo "Removing tag: $TAG"
              VERSION_ID=$(gh api \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "$API_PATH/packages/container/simple-health-check-app/versions" \
                --jq ".[] | select(.metadata.container.tags[] == \"$TAG\") | .id")
              
              if [ -n "$VERSION_ID" ]; then
                gh api \
                  --method DELETE \
                  -H "Accept: application/vnd.github+json" \
                  -H "X-GitHub-Api-Version: 2022-11-28" \
                  "$API_PATH/packages/container/simple-health-check-app/versions/$VERSION_ID" || true
              fi
            done
          else
            echo "No existing -released tags found"
          fi
          
          # Pull the version image
          echo "Pulling image: ghcr.io/$REPO_OWNER/simple-health-check-app:v$VERSION"
          docker pull ghcr.io/$REPO_OWNER/simple-health-check-app:v$VERSION
          
          # Tag with -released suffix
          echo "Tagging as: ghcr.io/$REPO_OWNER/simple-health-check-app:v$VERSION-released"
          docker tag ghcr.io/$REPO_OWNER/simple-health-check-app:v$VERSION ghcr.io/$REPO_OWNER/simple-health-check-app:v$VERSION-released
          
          # Push the -released tag
          echo "Pushing -released tag..."
          docker push ghcr.io/$REPO_OWNER/simple-health-check-app:v$VERSION-released
          
          echo "Successfully deployed v$VERSION-released"
          
          echo "### Deployed v$VERSION-released" >> $GITHUB_STEP_SUMMARY
          echo "Image: \`ghcr.io/$REPO_OWNER/simple-health-check-app:v$VERSION-released\`" >> $GITHUB_STEP_SUMMARY

