name: Build and Deploy
on:
  workflow_run:
    workflows: ["Version Bump"]
    types: [completed]
    branches: [master]

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Extract version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/simple-health-check-app
          tags: |
            type=raw,value=v${{ steps.version.outputs.VERSION }}
          
      - name: Build and Push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository_owner }}/simple-health-check-app:buildcache
          cache-to: type=registry,ref=ghcr.io/${{ github.repository_owner }}/simple-health-check-app:buildcache,mode=max

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Deploy version with -released tag
        env:
          VERSION: ${{ needs.build.outputs.version }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
        run: |
          echo "Deploying version: v$VERSION"
          
          # Install GitHub CLI if not available
          if ! command -v gh &> /dev/null; then
            echo "Installing GitHub CLI..."
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update
            sudo apt install gh -y
          fi
          
          # Authenticate gh with GITHUB_TOKEN
          echo "$GITHUB_TOKEN" | gh auth login --with-token
          
          # Get package versions and find all -released tags
          echo "Finding existing -released tags..."
          RELEASED_VERSIONS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/orgs/$REPO_OWNER/packages/container/simple-health-check-app/versions" \
            --jq '.[] | select(.metadata.container.tags[] | endswith("-released")) | .metadata.container.tags[] | select(endswith("-released"))')
          
          # Delete all -released tags
          if [ -n "$RELEASED_VERSIONS" ]; then
            echo "Found -released tags to remove:"
            echo "$RELEASED_VERSIONS"
            
            for TAG in $RELEASED_VERSIONS; do
              echo "Removing tag: $TAG"
              VERSION_ID=$(gh api \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "/orgs/$REPO_OWNER/packages/container/simple-health-check-app/versions" \
                --jq ".[] | select(.metadata.container.tags[] == \"$TAG\") | .id")
              
              if [ -n "$VERSION_ID" ]; then
                gh api \
                  --method DELETE \
                  -H "Accept: application/vnd.github+json" \
                  -H "X-GitHub-Api-Version: 2022-11-28" \
                  "/orgs/$REPO_OWNER/packages/container/simple-health-check-app/versions/$VERSION_ID" || true
              fi
            done
          else
            echo "No existing -released tags found"
          fi
          
          # Pull the version image
          echo "Pulling image: ghcr.io/$REPO_OWNER/simple-health-check-app:v$VERSION"
          docker pull ghcr.io/$REPO_OWNER/simple-health-check-app:v$VERSION
          
          # Tag with -released suffix
          echo "Tagging as: ghcr.io/$REPO_OWNER/simple-health-check-app:v$VERSION-released"
          docker tag ghcr.io/$REPO_OWNER/simple-health-check-app:v$VERSION ghcr.io/$REPO_OWNER/simple-health-check-app:v$VERSION-released
          
          # Push the -released tag
          echo "Pushing -released tag..."
          docker push ghcr.io/$REPO_OWNER/simple-health-check-app:v$VERSION-released
          
          echo "Successfully deployed v$VERSION-released"

