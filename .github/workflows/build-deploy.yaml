name: Build and Deploy
on:
  push:
    branches: [master]

concurrency:
  group: build-deploy
  cancel-in-progress: false

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    if: "startsWith(github.event.head_commit.message, 'chore: release v')"
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - name: Debug commit info
        run: |
          echo "Commit message: ${{ github.event.head_commit.message }}"
          echo "Author name: ${{ github.event.head_commit.author.name }}"
          echo "Author email: ${{ github.event.head_commit.author.email }}"
          echo "Actor: ${{ github.actor }}"
      
      - uses: actions/checkout@v4
      
      - name: Extract version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"
          
          # Set workflow run name with version
          echo "### Building v$VERSION" >> $GITHUB_STEP_SUMMARY
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/simple-health-check-app
          tags: |
            type=raw,value=v${{ steps.version.outputs.VERSION }}
          
      - name: Build and Push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository_owner }}/simple-health-check-app:buildcache
          cache-to: type=registry,ref=ghcr.io/${{ github.repository_owner }}/simple-health-check-app:buildcache,mode=max

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Deploy version with -released tag
        env:
          VERSION: ${{ needs.build.outputs.version }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
        run: |
          echo "Deploying version: v$VERSION"
          echo "Repository owner: $REPO_OWNER"
          
          # GitHub CLI uses GITHUB_TOKEN automatically, no need for manual login
          echo "âœ“ Using GITHUB_TOKEN for authentication"
          
          # Determine if owner is user or org
          echo "Detecting repository owner type..."
          OWNER_TYPE=$(gh api /users/$REPO_OWNER --jq '.type' 2>&1) || {
            echo "Failed to detect owner type, defaulting to user"
            OWNER_TYPE="User"
          }
          echo "Owner type: $OWNER_TYPE"
          
          if [ "$OWNER_TYPE" = "Organization" ]; then
            API_PATH="/orgs/$REPO_OWNER"
          else
            API_PATH="/users/$REPO_OWNER"
          fi
          echo "Using API path: $API_PATH"
          
          # Get package versions and find all -released tags
          echo "Finding existing -released tags..."
          RELEASED_VERSIONS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$API_PATH/packages/container/simple-health-check-app/versions" \
            --jq '.[] | select(.metadata.container.tags[] | endswith("-released")) | .metadata.container.tags[] | select(endswith("-released"))' 2>/dev/null || echo "")
          
          # Delete all -released tags
          if [ -n "$RELEASED_VERSIONS" ]; then
            echo "Found -released tags to remove:"
            echo "$RELEASED_VERSIONS"
            
            for TAG in $RELEASED_VERSIONS; do
              echo "Removing tag: $TAG"
              VERSION_ID=$(gh api \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "$API_PATH/packages/container/simple-health-check-app/versions" \
                --jq ".[] | select(.metadata.container.tags[] == \"$TAG\") | .id")
              
              if [ -n "$VERSION_ID" ]; then
                gh api \
                  --method DELETE \
                  -H "Accept: application/vnd.github+json" \
                  -H "X-GitHub-Api-Version: 2022-11-28" \
                  "$API_PATH/packages/container/simple-health-check-app/versions/$VERSION_ID" || true
              fi
            done
          else
            echo "No existing -released tags found"
          fi
          
          # Pull the version image
          echo "Pulling image: ghcr.io/$REPO_OWNER/simple-health-check-app:v$VERSION"
          docker pull ghcr.io/$REPO_OWNER/simple-health-check-app:v$VERSION
          
          # Tag with -released suffix
          echo "Tagging as: ghcr.io/$REPO_OWNER/simple-health-check-app:v$VERSION-released"
          docker tag ghcr.io/$REPO_OWNER/simple-health-check-app:v$VERSION ghcr.io/$REPO_OWNER/simple-health-check-app:v$VERSION-released
          
          # Push the -released tag
          echo "Pushing -released tag..."
          docker push ghcr.io/$REPO_OWNER/simple-health-check-app:v$VERSION-released
          
          echo "Successfully deployed v$VERSION-released"
          
          echo "### Deployed v$VERSION-released" >> $GITHUB_STEP_SUMMARY
          echo "Image: \`ghcr.io/$REPO_OWNER/simple-health-check-app:v$VERSION-released\`" >> $GITHUB_STEP_SUMMARY

